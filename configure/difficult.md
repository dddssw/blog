---
outline: deep
layout: doc
---

## 内存泄漏
线上的商城打开某个商品会出现页面卡死，页面没有报错，所以可能是出现了内存泄露，我打开devtool 里的performance monitor,有两项数据异常，一个是cpu占用，一个是js堆,

堆大小不断增加直到页面崩溃。我怀疑是出现了死循环。我尝试在本地复现，但是无法复现，我看页面也没有报错，但是同事电脑上有，应该是依赖问题，所以我更新了依赖。最后还是不行，后面发现跟依赖预构建有关

报错信息大概跟el-select组件相关，我在这个组件相关的函数里进行打印，发现会打印100次。这跟vue源码有关。

但是内存泄露的原因出在el-select上，我准备了一个最小复现，运行elementplus源码，在里面所有的watch进行打印，发现有个watch执行了100遍。于是就定位到了，之后提了一个pr

## 大文件切片
首先对文件进行切片，传入一个file对象，使用slice对文件按指定大小进行切割获得切片数组。

针对文件生成唯一标识，使用spark-md5(/spa:rk/)生成hash。考虑到这一步将占用大量资源，阻塞主线程。因此在web worker中进行这个操作

调用初始化上传接口，请求参数是切片数，文件hash。返回taskId

调用切片上传接口，入参切片序号，taskId,请求体里文件切片（formData），返回成功，更新上传进度

但是浏览器限制并发请求的个数，如果使用promise.all一次性的并发请求太多可能导致请求直接失败，使用p-limit帮助我们解决限制并发个数的问题

优化：

秒传，在初始化上传接口中如果后端根据hash发现文件已经存在，则会返回一个特殊的状态码表示该文件已存在

断点上传，调用初始化上传接口，如果没有上传完，返回缺失的切片序号，前端再补充上传缺失的切片即可

暂停上传，axios提供的AbortController取消上传
### 使用切片的原因
* 提高上传稳定性，当网络出现波动这个上传可能失败，通过断点续传，我们不需要重新上传整个文件
* 不管是客户端和服务端的内存消耗都会减少
* 通过小块上传，可以充分利用带宽，提升上传速度
* 可以提供更精确的上传进度反馈

### webworker传递大数据
主线程与webwork传递的数据是复制的，而不是共享，需要经过序列号与反序列化，大部分浏览器使用结构化克隆算法（structured clone algorithm）来实现。

但是可转移对象（ Transferable object）通过零拷贝操作从一个上下文转移到另一个上下文，这在发送大型数据集时可带来巨大的性能提升。

这些资源可以从一个上下文转移到另一个，但是资源一次只能在一个上下文可用
## vscode插件
我开发的时候遇到一个让我感觉麻烦的问题，当我使用一些公用的hook,它导出的东西比较多，我不得不去其他文件里复制再粘贴回来，这种切换上下文的操作让我感到非常不舒服。

我的思路是把公用的hooks和utils放在侧边栏下，点击导出的函数即可自动插入到当前光标的位置，我认为这对于每个项目都是通用的。想实现这个效果我必须借助vscode插件

因为我是从0开始开发的，所以需要走搭建框架，调试，开发，发布到插件市场整个流程，每个部分我都需要研究学习文档并且还需要学习node的部分api。当然报错是必不可少的，所以解决报错也花了很多时间。

完成这个功能我需要获取文件里导出的内容，实现这个功能的技术路线也十分曲折，最终确定使用babel的ast来获取导出内容，并且ast可以增强我们插件的能力，即便如此使用ast解析除导出内容也不是一样容易的是，所以针对这个功能还写了一个npm包

ui方面有两种实现分别是使用treeview或者webview，最终选择使用treeView

除了之外呢想做的更通用，通过vscode setting可以自由配置，例如现在默认所有的hooks是放在src下的hooks文件夹下，通过配置，不是叫hooks也行

还有最后一个优化点，修改导出的内容，插件不会有感知，所以内容还是旧的。我看了其他插件是带了一个refresh的按钮，我也实现了这个功能

并且通过vscodeapi可以实现实时监听不需要手动刷新，对性能也不会造成较大影响。使用zustand做全局状态管理
### ast节点查询优化
* 避免多次遍历，尽量在一次遍历收集全部信息，如果找到了节点，可以提前跳出对其子树的遍历
* 使用babel内置的路径查询api并对查询条件过滤
* 对已解析的文件建立缓存，如果没有修改就没必要重新解析
* 对高频查询节点创建索引
* 使用swc代替babel解析ast

### ast原理
* 首先进行词法分析，将源代码拆分成最小语法单元token,通过有限状态机生成token序列
* 进行语法分析，根据编程语言的语法规则，将Tokens组合成AST,语法分析器会检验代码是否符合语法规范

## 组件库
